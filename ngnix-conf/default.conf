# Optional: tune buffers/timeouts if you see 502s on long requests
proxy_http_version 1.1;
proxy_buffering off;

# Pass client details to the apps (important for Keycloak & HTTPS behind proxy)
map $http_x_forwarded_proto $best_proto {
  default $http_x_forwarded_proto;
  ""      $scheme;
}

server {
  listen 80 default_server;
  server_name _;

  # ----- Spring Boot API at /rest/ -> host port 9090 -----
  location /rest/ {
    proxy_set_header Host              $host;
    proxy_set_header X-Real-IP         $remote_addr;
    proxy_set_header X-Forwarded-For   $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $best_proto;
    proxy_redirect off;

    proxy_pass http://host.docker.internal:9090/;
  }

  location / {
    proxy_set_header Host              $host;
    proxy_set_header X-Real-IP         $remote_addr;
    proxy_set_header X-Forwarded-For   $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $best_proto;
    proxy_redirect off;

    proxy_pass http://host.docker.internal:18081/;
  }

  # Basic health check
  location = /health {
    return 200 "OK\n";
    add_header Content-Type text/plain;
  }
}